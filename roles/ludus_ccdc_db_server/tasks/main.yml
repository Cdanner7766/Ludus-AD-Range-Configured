---
# tasks file for ludus_ccdc_db_server
# Configures MariaDB/MySQL server with intentional CCDC vulnerabilities

# Install MySQL server (do NOT run apt upgrade - keep outdated packages)
- name: "Install MySQL server"
  ansible.builtin.apt:
    name:
      - mariadb-server
      - mariadb-client
      - python3-pymysql
    state: present
    update_cache: true
  become: true

# VULN: Bind MySQL to all interfaces so it's remotely accessible
- name: "VULN - Bind MySQL to all interfaces (0.0.0.0)"
  ansible.builtin.copy:
    dest: /etc/mysql/mariadb.conf.d/99-insecure.cnf
    content: |
      # INSECURE MySQL CONFIG
      # Secure option (DISABLED): bind-address = 127.0.0.1
      [mysqld]
      bind-address = 0.0.0.0
      # Secure option (DISABLED): local-infile = 0
      local-infile = 1
      # Secure option (DISABLED): skip-show-database
      # Allows SHOW DATABASES to all users
    owner: root
    group: root
    mode: "0644"
  become: true

- name: "Start and enable MySQL"
  ansible.builtin.systemd:
    name: mariadb
    state: restarted
    enabled: true
  become: true

# VULN: Set weak root password and allow remote root login
# Handles both fresh deploy (unix_socket auth) and re-deploy (password auth)
- name: "VULN - Set weak root password and create insecure users"
  ansible.builtin.shell: |
    # Determine how to connect: unix_socket (fresh) or password (re-deploy)
    if mysql -u root -e "SELECT 1" 2>/dev/null; then
      MYSQL_CMD="mysql -u root"
    elif mysql -u root -ppassword -e "SELECT 1" 2>/dev/null; then
      MYSQL_CMD="mysql -u root -ppassword"
    else
      echo "ERROR: Cannot connect to MariaDB as root"
      exit 1
    fi
    $MYSQL_CMD <<EOSQL
    -- VULN: Weak root password
    ALTER USER 'root'@'localhost' IDENTIFIED BY 'password';

    -- VULN: Allow root login from any host
    CREATE USER IF NOT EXISTS 'root'@'%' IDENTIFIED BY 'password';
    GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;

    -- VULN: Weak admin account with full privileges
    CREATE USER IF NOT EXISTS 'admin'@'%' IDENTIFIED BY 'admin';
    GRANT ALL PRIVILEGES ON *.* TO 'admin'@'%' WITH GRANT OPTION;

    -- VULN: Weak application user
    CREATE USER IF NOT EXISTS 'dbuser'@'%' IDENTIFIED BY 'dbuser';
    GRANT ALL PRIVILEGES ON *.* TO 'dbuser'@'%';

    -- VULN: Leave test database accessible (explicit weak user)
    CREATE DATABASE IF NOT EXISTS test;
    CREATE USER IF NOT EXISTS 'testuser'@'%' IDENTIFIED BY 'testuser';
    GRANT ALL PRIVILEGES ON test.* TO 'testuser'@'%';

    -- Create a sample CCDC database with dummy data
    CREATE DATABASE IF NOT EXISTS ccdc_company;
    USE ccdc_company;
    CREATE TABLE IF NOT EXISTS employees (
      id INT AUTO_INCREMENT PRIMARY KEY,
      name VARCHAR(100),
      email VARCHAR(100),
      ssn VARCHAR(11),
      salary DECIMAL(10,2)
    );
    INSERT IGNORE INTO employees VALUES (1, 'John Smith', 'jsmith@ludus.domain', '123-45-6789', 85000.00);
    INSERT IGNORE INTO employees VALUES (2, 'Jane Doe', 'jdoe@ludus.domain', '987-65-4321', 92000.00);

    FLUSH PRIVILEGES;
    EOSQL
  args:
    executable: /bin/bash
  become: true

# VULN: Disable firewall
- name: "VULN - Disable firewall"
  ansible.builtin.shell: |
    ufw disable || true
    iptables -F || true
    iptables -P INPUT ACCEPT || true
    iptables -P FORWARD ACCEPT || true
    iptables -P OUTPUT ACCEPT || true
  become: true

# VULN: Create weak local accounts
- name: "VULN - Create weak local accounts"
  ansible.builtin.shell: |
    useradd -m -s /bin/bash admin && echo 'admin:admin' | chpasswd
    useradd -m -s /bin/bash dbadmin && echo 'dbadmin:password' | chpasswd
    echo 'root:toor' | chpasswd
  become: true
  ignore_errors: true
