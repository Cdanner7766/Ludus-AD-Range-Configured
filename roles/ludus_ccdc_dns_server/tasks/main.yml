---
# tasks file for ludus_ccdc_dns_server
# Configures Windows DNS server with intentional CCDC vulnerabilities

# Install Windows DNS Server role
- name: "Install DNS Server role"
  ansible.windows.win_powershell:
    script: |
      Install-WindowsFeature -Name DNS -IncludeManagementTools

# Configure forward lookup zone for ludus.domain
- name: "Configure DNS forward lookup zone"
  ansible.windows.win_powershell:
    script: |
      # Add a standard primary zone (not AD-integrated, since this is a member server)
      try {
          Add-DnsServerPrimaryZone -Name "ludus.domain" -ZoneFile "ludus.domain.dns" -ErrorAction SilentlyContinue
      } catch {
          Write-Output "Zone may already exist"
      }
      # Derive the range network base from this VM's own IP address
      $myIp = (Get-NetIPAddress -InterfaceAlias "Ethernet*" -AddressFamily IPv4 | Where-Object { $_.IPAddress -like "10.*" }).IPAddress
      $parts = $myIp.Split('.')
      $base = "$($parts[0]).$($parts[1]).$($parts[2])"
      # Add sample DNS records for services using dynamically derived IPs
      Add-DnsServerResourceRecordA -ZoneName "ludus.domain" -Name "web" -IPv4Address "$base.31" -ErrorAction SilentlyContinue
      Add-DnsServerResourceRecordA -ZoneName "ludus.domain" -Name "db" -IPv4Address "$base.41" -ErrorAction SilentlyContinue
      Add-DnsServerResourceRecordA -ZoneName "ludus.domain" -Name "files" -IPv4Address "$base.51" -ErrorAction SilentlyContinue
      Add-DnsServerResourceRecordA -ZoneName "ludus.domain" -Name "mail" -IPv4Address "$base.61" -ErrorAction SilentlyContinue
      Add-DnsServerResourceRecordA -ZoneName "ludus.domain" -Name "ftp" -IPv4Address "$base.81" -ErrorAction SilentlyContinue
      Add-DnsServerResourceRecordMX -ZoneName "ludus.domain" -Name "." -MailExchange "mail.ludus.domain" -Preference 10 -ErrorAction SilentlyContinue

# VULN: Allow zone transfers to any server
- name: "VULN - Allow zone transfers to any host"
  ansible.windows.win_powershell:
    script: |
      # INSECURE: Allow AXFR to any host - attackers can dump full DNS zone
      # Secure option (DISABLED): Set-DnsServerZoneTransferPolicy to specific IPs
      # Secure option (DISABLED): SecureSecondaries = TransferToSecureServers
      Set-DnsServerPrimaryZone -Name "ludus.domain" -SecureSecondaries TransferAnyServer -ErrorAction SilentlyContinue
      # Also allow for reverse zone if it exists
      Get-DnsServerZone | Where-Object { $_.IsReverseLookupZone } | ForEach-Object {
          Set-DnsServerPrimaryZone -Name $_.ZoneName -SecureSecondaries TransferAnyServer -ErrorAction SilentlyContinue
      }

# VULN: Enable recursive queries from any source
- name: "VULN - Enable recursion from any source (DNS amplification risk)"
  ansible.windows.win_powershell:
    script: |
      # INSECURE: Recursion enabled for all - can be used for DNS amplification attacks
      # Secure option (DISABLED): Set-DnsServerRecursion -Enable $false
      Set-DnsServerRecursion -Enable $true
      # Secure option (DISABLED): Disable-DnsServerRootHints
      # VULN: No DNSSEC validation
      # Secure option (DISABLED): Set-DnsServerDsSetting -EnableDnsSec $true

# VULN: Disable Windows Firewall
- name: "VULN - Disable Windows Firewall"
  ansible.windows.win_powershell:
    script: |
      Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

# VULN: Disable DNS logging (no audit trail)
- name: "VULN - Disable DNS event logging (hide attacker activity)"
  ansible.windows.win_powershell:
    script: |
      # INSECURE: Disable DNS debug/event logging
      # Secure option (DISABLED): Set-DnsServerDiagnostics -All $true
      Set-DnsServerDiagnostics -All $false
